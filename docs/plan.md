# ElevenLabs Realtime Latency Plan (クレジット節約前提)

## 背景と課題
- 接続中は常にクレジット消費されるため、録音前から WebSocket を貼り続ける方式は不適。
- それでも初回 1～2 秒での転写抜けを防ぎ、ユーザーが録音ボタンを押した瞬間に話し始めても欠落しない UX が必要。
- ElevenLabs のドキュメント（`elevenlabs.md`）より、`session_started` 以降に 0.1–1.0 秒のチャンクを流し込むと低レイテンシで部分書き起こしが返るが、最初の 2 秒相当を送らないと処理が始まらない点に注意。

## ゴール
1. WebSocket を「必要な瞬間だけ」開き、無音待機中にクレジットが減り続ける状態を避ける。
2. 接続完了までに発話された音声を確実にサーバーへ渡す。
3. 接続時のペイロードを最適化し、`session_started` 直後に 2 秒分の音を一気に送出できるようにする。

## アーキテクチャ案
1. **録音開始 = ローカルリングバッファ開始**  
   - 録音ボタン押下で端末側に 5～10 秒程度のリングバッファ（PCM 16k）を用意し、WebSocket 接続の成否に関わらず音声を蓄積。
   - この段階では ElevenLabs には接続しないのでクレジットは減らない。

2. **接続準備の事前化**  
   - 録音画面が開かれた段階で以下を済ませておき、クリック～発話の間に必要な待ち時間をゼロに近づける。  
     - シングルユーストークンの取得（15 分有効なので UI 表示時にリクエストしてキャッシュ）。  
     - モデル名 / サンプルレートなどの設定確定。  
     - TLS/DNS ウォームアップ用の軽量 HEAD or REST コール（クレジットは発生しない）でレイテンシを測定し、最寄りリージョン（US/EU/IN）を選択。

3. **録音ボタン押下後に即 WebSocket を張る**  
   - 録音開始と同時に `startSession` が非同期で WebSocket を作成。`session_started` までの待機時間はローカルバッファが吸収。

4. **`session_started` 直後にバッファを吐き出す**  
   - WebSocket が確立したらリングバッファのデータを 0.2 秒程度のチャンクで高速送信し、マニュアルコミットのカウンタを初期化。  
   - これにより「最初の 2 秒を送らないと処理が始まらない」要件を即満たす。

5. **通常ストリーミングへ移行**  
   - バッファ分を送り切ったらライブ入力から 0.2–0.3 秒のチャンクで送信。必要に応じて 20–30 秒ごとに `commit`。  
   - 無音監視と UI の停止イベントで `commit` → `close` を実施し、不要な接続継続を避ける。

6. **早期切断と再利用**  
   - `finishSession` / 無音タイムアウトで即座に `commit` → `close`。  
   - 次の発話までの待ち時間が想定される場合は接続を維持せず、再度ステップ 1 から走らせる。トークンは 15 分の間で使い回し。

## 実装タスクの目安
1. リングバッファ実装（最大 10 秒の PCM を保持、スレッドセーフ）。  
2. `startSession` を改修し、`session_started` イベントまで送信を遅延。  
3. `receiveTask` 内で `session_started` をフラグ化し、バッファ吐き出し処理をキック。  
4. UI 層でのトークン事前取得とリージョン選択ロジック。  
5. 無音検知 or ユーザー停止で `commit` → `close` を確実に行うクレジット節約フロー。  
6. 監視用にセッション時間 / 消費クレジット見積もりをログに記録し、運用上のチューニングに備える。

この構成なら「常時接続によるクレジット垂れ流し」を防ぎながら、ユーザーの冒頭発話を欠落させずに ElevenLabs Realtime の低レイテンシ特性を活かせます。
